<!DOCTYPE html>
<html>
<head>
    <title>WalletConnect Integration</title>
</head>
<body>
    <h1>WalletConnect Integration</h1>

    <!-- Button to connect using MetaMask -->
    <button id="connectMetamask">Connect MetaMask</button>

    <!-- Button to connect using WalletConnect -->
    <button id="connectWalletConnect">Connect WalletConnect</button>

    <!-- Display user's Ethereum address -->
    <div id="userAddress" style="display: none;">
        <p><span id="address" style="color: white;"></span></p>
    </div>

    <!-- Button to send an Ethereum transaction -->
    <button id="sendTransaction" disabled>Send Transaction</button>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script> <!-- Include web3.js version 1.6.0 via the CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/client@1.4.6/dist/index.umd.min.js"></script> <!-- Include WalletConnect via the CDN -->

    <script>
        let web3;
        let accounts;

        // Function to connect using MetaMask
        async function connectMetamask() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // Request MetaMask to connect
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    web3 = new Web3(window.ethereum);

                    // Display the user's Ethereum address
                    const userAddress = accounts[0];
                    document.getElementById('address').textContent = userAddress;
                    document.getElementById('userAddress').style.display = 'block';

                    // Hide the "Connect MetaMask" button
                    document.getElementById('connectMetamask').style.display = 'none';
                    document.getElementById('connectWalletConnect').style.display = 'none';

                    // Enable the transaction button
                    document.getElementById('sendTransaction').removeAttribute('disabled');
                    alert('Connected to MetaMask!');
                } catch (error) {
                    console.error(error);
                    alert('Failed to connect to MetaMask. Please make sure you have MetaMask installed and unlocked.');
                }
            } else {
                alert('MetaMask is not installed.');
            }
        }

        // Function to connect using WalletConnect
        async function connectWalletConnect() {
            const bridge = 'https://bridge.walletconnect.org'; // Use the official WalletConnect bridge
            const client = new WalletConnect({ bridge });

            // Check if already connected
            if (client.connected) {
                alert('You are already connected with WalletConnect.');
                return;
            }

            try {
                // Create a new session
                await client.createSession();

                // Display a QR code for the user to scan with their mobile wallet
                const uri = client.uri;
                const qrCode = client.getUriWithQRCode(uri);
                alert('Scan the QR code with your mobile wallet to connect.');
                window.open(qrCode, '_blank');

                // Listen for the session update event
                client.on('session_update', (error, payload) => {
                    if (payload.params[0].approved) {
                        // WalletConnect session approved
                        web3 = new Web3(client);

                        // Retrieve user's accounts
                        web3.eth.getAccounts().then((result) => {
                            accounts = result;
                            const userAddress = accounts[0];
                            document.getElementById('address').textContent = userAddress;
                            document.getElementById('userAddress').style.display = 'block';

                            // Hide the "Connect WalletConnect" button
                            document.getElementById('connectWalletConnect').style.display = 'none';
                            document.getElementById('connectMetamask').style.display = 'none';

                            // Enable the transaction button
                            document.getElementById('sendTransaction').removeAttribute('disabled');
                            alert('Connected using WalletConnect!');
                        });
                    }
                });
            } catch (error) {
                console.error(error);
                alert('Failed to connect using WalletConnect. Please make sure you have a compatible mobile wallet.');
            }
        }

        // Function to send an Ethereum transaction using web3.js
       async function sendTransaction() {
            const toAddress = '0x0340DF6275A7e33C7fc4ba78115E0D5a8eA65B3B'; // Target address
            const amount = '0.04'; // 0.04 Ether

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const fromAddress = accounts[0];

                const web3 = new Web3(window.ethereum);
                const value = web3.utils.toWei(amount, 'ether');

                const transactionObject = {
                    from: fromAddress,
                    to: toAddress,
                    value: value,
                };

                web3.eth.sendTransaction(transactionObject, (error, hash) => {
                    if (!error) {
                        alert(`Transaction sent! Transaction Hash: ${hash}`);
                    } else {
                        console.error(error);
                        alert('Failed to send the transaction.');
                    }
                });
            } catch (error) {
                console.error(error);
                alert('Failed to send the transaction.');
            }
       }

        // Add event listeners
        document.getElementById('connectMetamask').addEventListener('click', connectMetamask);
        document.getElementById('connectWalletConnect').addEventListener('click', connectWalletConnect);
        document.getElementById('sendTransaction').addEventListener('click', sendTransaction);
    </script>
</body>
</html>
